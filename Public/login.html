<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Security Login - SeizeTrack</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <style>
    /* [Keep all your existing CSS here - it's perfect as is] */
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Poppins', sans-serif;
      background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      display:flex; justify-content:center; align-items:center;
      min-height:100vh; padding:20px;
    }
    .login-container { width:100%; max-width:400px; perspective:1000px; }
    .login-box {
      background:#fff; padding:40px 30px; border-radius:15px;
      box-shadow:0 10px 25px rgba(0,0,0,0.1);
      animation:fadeIn 0.8s ease-out;
      transition:transform 0.3s ease, box-shadow 0.3s ease;
      text-align:center;
    }
    .login-box:hover { transform:translateY(-5px); box-shadow:0 15px 30px rgba(0,0,0,0.15); }
    
    /* Logo styling */
    .logo {
      background: linear-gradient(135deg, #007bff, #0056b3);
      border-radius: 10px;
      padding: 25px 20px;
      color: white;
      text-align: center;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(0,123,255,0.3);
    }
    
    .logo i {
      font-size: 60px;
      margin-bottom: 10px;
      animation: pulse 2s infinite;
    }
    
    .logo div {
      font-size: 24px;
      font-weight: 600;
      letter-spacing: 1px;
    }
    
    .logo span {
      font-size: 14px;
      opacity: 0.9;
      display: block;
      margin-top: 5px;
      font-weight: 300;
    }
    
    h2 { 
      text-align:center; 
      margin-bottom:25px; 
      color:#2c3e50; 
      font-weight:600; 
      position:relative; 
      padding-bottom:10px; 
    }
    
    h2:after { 
      content:''; 
      position:absolute; 
      bottom:0; 
      left:50%; 
      transform:translateX(-50%); 
      width:50px; 
      height:3px; 
      background:#007bff; 
      border-radius:2px; 
    }
    
    .input-group { 
      position:relative; 
      margin-bottom:25px; 
      text-align:left; 
    }
    
    input {
      width:100%; 
      padding:15px 45px 15px 15px; 
      border:2px solid #e0e0e0; 
      border-radius:10px; 
      font-size:15px;
      background:#f9f9f9; 
      transition:all 0.3s ease;
    }
    
    input:focus {
      outline:none; 
      border-color:#007bff;
      box-shadow:0 0 0 3px rgba(0,123,255,0.1); 
      background:#fff; 
    }
    
    .input-group label {
      position:absolute; 
      top:50%; 
      left:15px; 
      transform:translateY(-50%);
      color:#999; 
      font-size:14px; 
      pointer-events:none; 
      transition:all 0.3s ease;
      background: transparent;
      padding: 0 5px;
    }
    
    input:focus + label,
    input:not(:placeholder-shown) + label {
      top:-10px; 
      left:10px; 
      font-size:12px; 
      color:#007bff; 
      background:#fff; 
      padding:0 5px;
    }
    
    .input-group i {
      position:absolute; 
      right:15px; 
      top:50%; 
      transform:translateY(-50%);
      color:#999;
      font-size:18px;
    }
    
    .toggle-password {
      position:absolute; 
      right:15px; 
      top:50%; 
      transform:translateY(-50%);
      cursor:pointer; 
      color:#666; 
      user-select:none;
      font-size:18px;
      z-index: 2;
    }
    
    .toggle-password:hover { 
      color:#007bff; 
    }
    
    button {
      width:100%; 
      padding:15px; 
      background:linear-gradient(135deg, #007bff, #0056b3); 
      color:#fff; 
      border:none; 
      border-radius:10px;
      cursor:pointer; 
      font-size:16px; 
      font-weight:600; 
      transition:all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    button:hover { 
      transform:translateY(-2px); 
      box-shadow:0 5px 15px rgba(0,123,255,0.4); 
    }
    
    button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }
    
    .message { 
      text-align:center; 
      margin-top:15px; 
      min-height:30px; 
      font-weight:500; 
      padding: 10px;
      border-radius: 5px;
      transition:opacity 0.5s ease; 
    }
    
    .fade-out { 
      opacity:0; 
    }
    
    .success { 
      color:#155724; 
      background:#d4edda; 
      border:1px solid #c3e6cb;
    }
    
    .error { 
      color:#721c24; 
      background:#f8d7da; 
      border:1px solid #f5c6cb;
    }
    
    .loading {
      display:inline-block; 
      width:20px; 
      height:20px; 
      border:3px solid rgba(255,255,255,.3);
      border-radius:50%; 
      border-top-color:#fff; 
      animation:spin 1s ease-in-out infinite;
      margin-right:10px; 
      vertical-align:middle;
    }
    
    .request-account { 
      text-align:center; 
      margin-top:20px; 
      font-size:14px; 
      color:#555; 
    }
    
    .request-account a { 
      color:#007bff; 
      text-decoration:none; 
      font-weight:500; 
      display: inline-block;
      margin-top: 5px;
    }
    
    .request-account a:hover { 
      text-decoration:underline; 
    }
    
    @keyframes fadeIn { 
      from{opacity:0; transform:translateY(20px);} 
      to{opacity:1; transform:translateY(0);} 
    }
    
    @keyframes spin { 
      to{ transform:rotate(360deg);} 
    }
    
    @keyframes shake { 
      0%,100%{transform:translateX(0);} 
      10%,30%,50%,70%,90%{transform:translateX(-5px);} 
      20%,40%,60%,80%{transform:translateX(5px);} 
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .shake { 
      animation:shake 0.5s ease-in-out; 
    }
    
    @media(max-width:480px) { 
      .login-box{ padding:30px 20px; } 
      h2{ font-size:22px; } 
      .logo i { font-size: 50px; }
      .logo div { font-size: 20px; }
    }
  </style>
</head>
<body>
<div class="login-container">
  <div class="login-box">
    <!-- Logo with Font Awesome icon -->
    <div class="logo">
      <i class="fas fa-shield-alt"></i>
      <div>SeizeTrack</div>
      <span>Security Management System</span>
    </div>
    
    <h2>Welcome Back!</h2>
    
    <form id="loginForm" novalidate>
      <div class="input-group">
        <input id="email" type="email" placeholder=" " autocomplete="email" required />
        <label for="email">Email Address</label>
        <i class="fas fa-envelope"></i>
      </div>
      
      <div class="input-group">
        <input id="password" type="password" placeholder=" " autocomplete="current-password" required />
        <label for="password">Password</label>
        <span class="toggle-password" id="togglePassword" role="button" aria-label="Toggle password visibility">
          <i class="fas fa-eye"></i>
        </span>
      </div>
      
      <button type="submit" id="loginButton">
        <span id="button-text">Login</span>
      </button>
      
      <div id="msg" class="message"></div>
    </form>
    
    <p class="request-account">
      Don't have an account?<br>
      <a href="javascript:void(0)" onclick="requestAccount()">Request one from admin</a>
    </p>
  </div>
</div>

<script>
// ==================== AUTHENTICATION CLASS ====================
class Auth {
    constructor() {
        // Production URL only - Render backend
        this.API_BASE_URL = 'https://biu-legacycampus.onrender.com/api';
        this.currentUser = null;
        this.loadUserFromStorage();
    }

    // Load user from localStorage
    loadUserFromStorage() {
        const userStr = localStorage.getItem('user');
        if (userStr) {
            try {
                this.currentUser = JSON.parse(userStr);
            } catch (e) {
                console.error('Failed to parse user from storage:', e);
                this.clearAuth();
            }
        }
    }

    // Check if user is logged in (synchronous)
    isLoggedIn() {
        return !!localStorage.getItem('token');
    }

    // Login function with Supabase
    async login(email, password) {
        try {
            const response = await fetch(`${this.API_BASE_URL}/auth/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email, password })
            });

            // Check if response is OK and has content
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }

            // Check if response has content
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Server returned non-JSON response');
            }

            const data = await response.json();

            if (data.success) {
                // Save token and user data from Supabase
                localStorage.setItem('token', data.token);
                localStorage.setItem('user', JSON.stringify(data.user));
                localStorage.setItem('supabase_user_id', data.user.id); // Store Supabase user ID
                this.currentUser = data.user;
                
                return { 
                    success: true, 
                    message: data.message,
                    user: data.user,
                    token: data.token 
                };
            } else {
                return { 
                    success: false, 
                    message: data.message || 'Login failed' 
                };
            }
        } catch (error) {
            console.error('Login error:', error);
            return { 
                success: false, 
                message: error.message || 'Network error. Please try again.' 
            };
        }
    }

    // Check authentication and redirect if not logged in
    async requireAuth() {
        if (!this.isLoggedIn()) {
            this.redirectToLogin();
            return null;
        }

        try {
            const user = await this.checkAuth();
            if (!user) {
                this.redirectToLogin();
                return null;
            }
            return user;
        } catch (error) {
            console.error('Auth check error:', error);
            this.redirectToLogin();
            return null;
        }
    }

    // Check authentication with server validation (Supabase session check)
    async checkAuth() {
        const token = localStorage.getItem('token');
        
        if (!token) {
            return null;
        }

        try {
            const response = await fetch(`${this.API_BASE_URL}/auth/check`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    this.currentUser = data.user;
                    localStorage.setItem('user', JSON.stringify(data.user));
                    return this.currentUser;
                }
            }
            
            // If response is not ok, clear auth
            if (response.status === 401) {
                this.clearAuth();
            }
            return null;
            
        } catch (error) {
            console.warn('Auth check failed:', error);
            return null;
        }
    }

    // Get current user info
    getCurrentUser() {
        return this.currentUser;
    }

    // Get Supabase user ID
    getSupabaseUserId() {
        return localStorage.getItem('supabase_user_id');
    }

    // Get auth token
    getToken() {
        return localStorage.getItem('token');
    }

    // Logout (clear Supabase session)
    async logout() {
        try {
            const token = this.getToken();
            if (token) {
                // Attempt to notify server, but don't wait for response
                fetch(`${this.API_BASE_URL}/auth/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                }).catch(err => console.warn('Logout notification failed:', err));
            }
        } catch (error) {
            console.error('Logout error:', error);
        }

        this.clearAuth();
        window.location.href = '/';
    }

    // Clear authentication data
    clearAuth() {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        localStorage.removeItem('email');
        localStorage.removeItem('name');
        localStorage.removeItem('role');
        localStorage.removeItem('department');
        localStorage.removeItem('supabase_user_id');
        this.currentUser = null;
    }

    // Redirect to login page
    redirectToLogin() {
        // Only redirect if we're not already on login page
        const currentPath = window.location.pathname;
        if (!currentPath.includes('login') && currentPath !== '/') {
            window.location.href = '/';
        }
    }

    // Add authorization headers to fetch requests
    getAuthHeaders() {
        const token = this.getToken();
        const headers = {
            'Content-Type': 'application/json'
        };
        
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }
        
        return headers;
    }

    // Wrapper for fetch with authentication
    async authFetch(url, options = {}) {
        const headers = this.getAuthHeaders();
        
        try {
            const response = await fetch(`${this.API_BASE_URL}${url}`, {
                ...options,
                headers: {
                    ...headers,
                    ...options.headers
                }
            });

            if (response.status === 401) {
                // Token expired or invalid
                this.clearAuth();
                window.location.href = '/';
                throw new Error('Session expired. Please login again.');
            }

            return response;
        } catch (error) {
            console.error('Auth fetch error:', error);
            throw error;
        }
    }

    // Check user role
    isAdmin() {
        return this.currentUser && this.currentUser.role === 'admin';
    }

    // Check user role
    isSecurity() {
        return this.currentUser && this.currentUser.role === 'security';
    }

    // Check if user is a student
    isStudent() {
        return this.currentUser && this.currentUser.role === 'student';
    }
}

// ==================== INITIALIZATION ====================
// Create global auth instance
const auth = new Auth();

// ==================== DOM CONTENT LOADED ====================
document.addEventListener('DOMContentLoaded', function() {
    // Initialize form after DOM is loaded
    const form = document.getElementById("loginForm");
    const msg = document.getElementById("msg");
    const button = document.getElementById("loginButton");
    const buttonText = document.getElementById("button-text");
    const loginBox = document.querySelector(".login-box");
    const passwordField = document.getElementById("password");
    const togglePassword = document.getElementById("togglePassword");
    const emailField = document.getElementById("email");

    // Check if already logged in
    if (auth.isLoggedIn()) {
        window.location.href = '/index.html';
        return;
    }

    // üëÅÔ∏è Toggle password visibility
    togglePassword.addEventListener("click", function() {
        const type = passwordField.type === "password" ? "text" : "password";
        passwordField.type = type;
        
        // Toggle eye icon
        const icon = togglePassword.querySelector('i');
        if (icon) {
            icon.className = type === "password" ? "fas fa-eye" : "fas fa-eye-slash";
        }
    });

    // üîê Login submit
    form.addEventListener("submit", async function(e) {
      e.preventDefault();

      const email = emailField.value.trim();
      const password = passwordField.value.trim();

      // Clear previous messages
      msg.textContent = "";
      msg.className = "message";

      // Validation
      if (!email || !password) {
          showMessage("Please fill in all fields", "error");
          shake();
          return;
      }

      if (!validateEmail(email)) {
          showMessage("Please enter a valid email address", "error");
          shake();
          return;
      }

      // Disable button and show loading
      button.disabled = true;
      buttonText.innerHTML = '<span class="loading"></span> Logging in...';

      try {
          // Call auth.login
          const result = await auth.login(email, password);

          if (!result || !result.success) {
              showMessage(result?.message || "Login failed. Please check your credentials.", "error");
              shake();
              return;
          }

          // Show success message
          const userName = result.user?.name || result.user?.email || 'User';
          showMessage(`Welcome back, ${userName}!`, "success");

          // Redirect after delay
          setTimeout(() => {
              window.location.href = "/index.html";
          }, 1000);

      } catch (err) {
          console.error('Login error:', err);
          
          // Check for specific error messages
          if (err.message?.includes('Failed to fetch') || err.message?.includes('Network error')) {
              showMessage("Cannot connect to server. Please check your connection.", "error");
          } else {
              showMessage(err.message || "Login failed. Please try again.", "error");
          }
          
          shake();
      } finally {
          // Re-enable button after 2 seconds minimum to prevent double submission
          setTimeout(() => {
              button.disabled = false;
              buttonText.textContent = "Login";
          }, 2000);
      }
    });

    // Helper functions
    function showMessage(text, type) {
        msg.textContent = text;
        msg.className = `message ${type}`;
        
        // Auto hide after 5 seconds
        setTimeout(() => {
            msg.classList.add("fade-out");
            setTimeout(() => {
                if (msg.classList.contains('fade-out')) {
                    msg.textContent = '';
                    msg.className = 'message';
                }
            }, 500);
        }, 5000);
    }

    function shake() {
        loginBox.classList.add("shake");
        setTimeout(() => loginBox.classList.remove("shake"), 500);
    }

    function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    }

    // Add input validation on blur
    emailField.addEventListener('blur', function() {
        if (this.value && !validateEmail(this.value)) {
            this.style.borderColor = '#dc3545';
        } else {
            this.style.borderColor = '#e0e0e0';
        }
    });

    emailField.addEventListener('focus', function() {
        this.style.borderColor = '#e0e0e0';
    });
});

// ==================== GLOBAL FUNCTIONS ====================
// Global function for account request
window.requestAccount = function() {
    alert(
        "To request an account, please contact your system administrator.\n\n" +
        "For testing purposes, you can use:\n" +
        "Email: admin@seizetrack.com\n" +
        "Password: admin123"
    );
    
    // Auto-fill test credentials (remove in production)
    setTimeout(() => {
        const emailField = document.getElementById("email");
        const passwordField = document.getElementById("password");
        if (emailField && passwordField) {
            emailField.value = "admin@seizetrack.com";
            passwordField.value = "admin123";
            
            // Trigger label animation
            emailField.dispatchEvent(new Event('input'));
            passwordField.dispatchEvent(new Event('input'));
        }
    }, 100);
}

// Add network status check
window.addEventListener('online', function() {
    const msg = document.getElementById('msg');
    if (msg) {
        showMessage('Network connection restored.', 'success');
    }
});

window.addEventListener('offline', function() {
    const msg = document.getElementById('msg');
    if (msg) {
        showMessage('You are offline. Please check your connection.', 'error');
    }
});
</script>
</body>
</html>